{% extends 'core/base.html' %}

{% block title %}Página Inicial - Gestão de Máquinas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="h2 mb-0">Inventário de Máquinas</h1>
    <div class="text-end">
        <span class="badge bg-success p-2 fs-6">
            <span id="maquinas-disponiveis-count">--</span> Máquinas Disponíveis
        </span>
    </div>
</div>

<!-- Barra de Pesquisa -->
<div class="row justify-content-center mb-4">
    <div class="col-md-8 col-lg-6">
        <form id="search-form">
            <div class="input-group">
                <input type="search" class="form-control" name="q" placeholder="Pesquisar por nome, modelo ou património...">
                <button class="btn btn-outline-secondary" type="submit">
                    <i class="bi bi-search"></i> Pesquisar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Container para o Acordeão de Categorias -->
<div id="dashboard-container" class="accordion">

    <div class="col-12 text-center" id="loading-indicator">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">A carregar...</span>
        </div>
        <p class="mt-2">A carregar inventário...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dashboardContainer = document.getElementById('dashboard-container');
    const searchForm = document.getElementById('search-form');
    const searchInput = searchForm.querySelector('input');
    const currentUser = {
        id: {{ user.id }},
        isAdmin: {{ user.is_superuser|yesno:"true,false" }} || {% if user.user_type == 'admin' %}true{% else %}false{% endif %}
    };
    let refreshInterval;

    function createMachineCard(maquina) {
        const sol = maquina.solicitacao;
        const cardClass = sol ? 'border-warning' : '';

        const statusIcon = maquina.status === 'disponivel' ? 'bi-check-circle-fill' : 'bi-person-fill-gear';
        const statusClass = maquina.status === 'disponivel' ? 'bg-success-subtle text-success-emphasis' : 'bg-warning-subtle text-warning-emphasis';
        const statusBadge = `<span class="badge small ${statusClass} d-flex align-items-center"><i class="bi ${statusIcon} me-1"></i> ${maquina.status_display}</span>`;
        

        let tipoMaquinaBadge = '';
        if (maquina.tipo_maquina === 'Desenvolvimento') {
            tipoMaquinaBadge = `<span class="badge small bg-info-subtle text-info-emphasis d-flex align-items-center"><i class="bi bi-tools me-1"></i> DEV</span>`;
        } else if (maquina.tipo_maquina === 'Produção') {
            tipoMaquinaBadge = `<span class="badge small bg-secondary-subtle text-secondary-emphasis d-flex align-items-center"><i class="bi bi-hdd-stack-fill me-1"></i> PROD</span>`;
        }


        let posseHtml = '';
        if (maquina.posse_atual) {
            const userFoto = maquina.posse_atual.foto_url || `https://placehold.co/100x100/e9ecef/495057?text=${maquina.posse_atual.nome.charAt(0)}`;
            posseHtml = `
                <div class="d-flex align-items-center small mb-3">
                    <img src="${userFoto}" class="rounded-circle me-2" width="30" height="30" alt="Foto de ${maquina.posse_atual.nome}">
                    <span>Com: <strong>${maquina.posse_atual.nome}</strong></span>
                </div>`;
        }
        
        const numeroSerieHtml = maquina.numero_serie 
            ? `<p class="card-text text-muted small mb-2">Série: ${maquina.numero_serie}</p>`
            : '<p class="card-text text-muted small mb-2">Série: --</p>';


        let buttonsHtml = '';
        if (currentUser.isAdmin) {
            if (sol && sol.status === 'pendente_aprovacao') {
                const solicitanteFoto = sol.solicitante.foto_url || `https://placehold.co/100x100/e9ecef/495057?text=${sol.solicitante.nome.charAt(0)}`;
                const solicitacaoInfo = `
                    <div class="d-flex align-items-center mb-2">
                        <img src="${solicitanteFoto}" class="rounded-circle me-2" width="40" height="40" alt="Foto de ${sol.solicitante.nome}">
                        <div>
                            <strong class="d-block">${sol.solicitante.nome}</strong>
                            <small class="text-muted">solicitou a ${sol.tipo.toLowerCase()}</small>
                        </div>
                    </div>`;
                buttonsHtml = `<div class="alert alert-warning p-2">${solicitacaoInfo}<div class="d-grid gap-1 mt-2">
                    <a href="/processar/${sol.id}/aprovar/" class="btn btn-sm btn-success">Aprovar</a>
                    <a href="/processar/${sol.id}/negar/" class="btn btn-sm btn-danger">Negar</a>
                </div></div>`;
            } else if (sol && sol.status === 'pendente_confirmacao') {
                 buttonsHtml = `<div class="alert alert-secondary p-2 text-center small fst-italic">A aguardar confirmação de <strong>${sol.posse_anterior.nome}</strong>.</div>`;
            } else {
                buttonsHtml = `<div class="text-center text-muted small p-3">Nenhuma ação necessária.</div>`;
            }
        } else {
            if (sol) {
                if (sol.status === 'pendente_confirmacao' && maquina.posse_atual && maquina.posse_atual.id === currentUser.id) {
                     buttonsHtml = `<div class="alert alert-warning p-2"><p class="small text-center mb-1"><strong>${sol.solicitante.nome}</strong> quer esta máquina.</p><div class="d-grid">
                        <a href="/confirmar-troca/${sol.id}/" class="btn btn-sm btn-warning">Confirmar Intenção de Troca</a>
                    </div></div>`;
                } else if (sol.solicitante.id === currentUser.id) {
                    const statusText = sol.status === 'pendente_aprovacao' ? 'A aguardar aprovação do admin...' : `A aguardar confirmação de <strong>${sol.posse_anterior.nome}</strong>...`;
                    buttonsHtml = `<div class="alert alert-info p-2"><div class="text-center small fst-italic">${statusText}</div>
                    <a href="/cancelar-solicitacao/${sol.id}/" class="btn btn-sm btn-outline-danger w-100 mt-2">Cancelar Solicitação</a></div>`;
                } else {
                     buttonsHtml = `<button class="btn btn-secondary" disabled>Operação pendente</button>`;
                }
            } else {
                if (maquina.status === 'disponivel') {
                    buttonsHtml = `<a href="/solicitar/${maquina.id}/retirada/" class="btn btn-primary"><i class="bi bi-arrow-down-square"></i> Solicitar Retirada</a>`;
                } else if (maquina.posse_atual && maquina.posse_atual.id === currentUser.id) {
                    buttonsHtml = `<a href="/solicitar/${maquina.id}/devolucao/" class="btn btn-info"><i class="bi bi-arrow-up-square"></i> Solicitar Devolução</a>`;
                } else {
                    buttonsHtml = `<a href="/solicitar/${maquina.id}/troca/" class="btn btn-warning"><i class="bi bi-arrow-repeat"></i> Solicitar Troca</a>`;
                }
            }
        }
        
        return `
            <div class="col">
                <div class="card h-100 shadow-sm ${cardClass}">
                    <img src="${maquina.foto_url}" class="card-img-top" alt="Foto de ${maquina.nome}">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title">${maquina.nome}</h5>
                            ${maquina.patrimonio ? `<span class="badge bg-light text-dark align-self-start">#${maquina.patrimonio}</span>` : ''}
                        </div>
                        <p class="card-text text-muted mb-1">${maquina.tipo_modelo}</p>
                        ${numeroSerieHtml}
                        <div class="d-flex gap-2 mb-2">
                            ${statusBadge}
                            ${tipoMaquinaBadge}
                        </div>
                        ${posseHtml}
                        <div class="mt-auto d-grid gap-2">${buttonsHtml}</div>
                    </div>
                </div>
            </div>`;
    }

    function updateDashboard(data, accordionState) {
        let newHtml = '';
        const categorias = Object.keys(data.maquinas_por_categoria);

        if (categorias.length === 0) {
            newHtml = '<div class="col-12"><div class="alert alert-info text-center">Nenhuma máquina encontrada.</div></div>';
        } else {
            categorias.forEach((categoria, index) => {
                const maquinas = data.maquinas_por_categoria[categoria];
                const collapseId = `collapse-${index}`;
                
                const isCollapsed = accordionState[collapseId] === false;
                const showClass = isCollapsed ? '' : 'show';
                const buttonClass = isCollapsed ? 'collapsed' : '';
                
                let machineCardsHtml = '';
                maquinas.forEach(maquina => {
                    machineCardsHtml += createMachineCard(maquina);
                });

                newHtml += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${buttonClass}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                ${categoria}&nbsp;<span class="badge bg-secondary">${maquinas.length}</span>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${showClass}">
                            <div class="accordion-body">
                                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                                    ${machineCardsHtml}
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
        }
        
        dashboardContainer.innerHTML = newHtml;
        document.getElementById('maquinas-disponiveis-count').textContent = data.maquinas_disponiveis;
    }

    function fetchDashboardStatus() {
        const accordionState = {};
        const collapses = dashboardContainer.querySelectorAll('.accordion-collapse');
        collapses.forEach(collapse => {
            accordionState[collapse.id] = collapse.classList.contains('show');
        });

        const query = searchInput.value;
        const url = `{% url 'dashboard_status' %}?q=${encodeURIComponent(query)}`;

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                updateDashboard(data, accordionState);
            })
            .catch(error => {
                console.error('Erro ao buscar status:', error);
                if (document.getElementById('loading-indicator')) {
                    dashboardContainer.innerHTML = '<div class="alert alert-warning">Não foi possível ligar ao servidor. Verifique a sua ligação.</div>';
                }
            });
    }

    function startRefreshInterval() {
        if (!refreshInterval) {
            refreshInterval = setInterval(fetchDashboardStatus, 5000);
        }
    }
    function stopRefreshInterval() {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }

    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        fetchDashboardStatus();
    });
    
    searchInput.addEventListener('focus', stopRefreshInterval);
    searchInput.addEventListener('blur', startRefreshInterval);

    fetchDashboardStatus();
    startRefreshInterval();
});
</script>
{% endblock %}

