{% extends 'core/base.html' %}

{% block title %}Confirmar Operação{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <!-- Wrapper para facilitar a substituição do conteúdo -->
        <div id="confirmation-wrapper">
            <div class="card shadow">
                <div class="card-header">
                    <h4 class="mb-0">Confirmar {{ tipo_operacao }} de Máquina</h4>
                </div>
                <div class="card-body p-4">
                    <!-- Container para mensagens de erro -->
                    <div id="error-message-container" class="mb-3"></div>

                    <p class="card-text">
                        Você está confirmando a <strong>{{ tipo_operacao|lower }}</strong> da máquina:
                    </p>
                    <h5 class="mb-4 text-center"><strong>{{ maquina.nome }}</strong></h5>

                    <form id="confirmation-form" method="post" novalidate>
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="{{ form.codigo.id_for_label }}" class="form-label">{{ form.codigo.label }}</label>
                            {{ form.codigo }}
                            {% if form.codigo.help_text %}
                            <div class="form-text">{{ form.codigo.help_text }}</div>
                            {% endif %}
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check2-circle"></i> Confirmar {{ tipo_operacao }}
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('confirmation-form');
        const wrapper = document.getElementById('confirmation-wrapper');
        const errorMessageContainer = document.getElementById('error-message-container');

        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Impede o envio padrão do formulário

            const formData = new FormData(form);
            const url = form.action;
            const submitButton = form.querySelector('button[type="submit"]');

            // Mostra um estado de carregamento no botão
            submitButton.disabled = true;
            submitButton.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Verificando...
        `;
            errorMessageContainer.innerHTML = ''; // Limpa erros antigos

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (ok) { // Sucesso (status 2xx)
                        // Substitui o formulário pela mensagem de sucesso
                        wrapper.innerHTML = `
                    <div class="card text-center shadow border-success">
                        <div class="card-body p-5">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                            <h3 class="mt-3">Operação Confirmada!</h3>
                            <p class="lead">${data.message}</p>
                            <a href="{% url 'home' %}" class="btn btn-primary mt-3">Voltar para o Início</a>
                        </div>
                    </div>
                `;
                    } else { // Erro (status 4xx ou 5xx)
                        // Mostra a mensagem de erro e reativa o botão
                        errorMessageContainer.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                        submitButton.disabled = false;
                        submitButton.innerHTML = `<i class="bi bi-check2-circle"></i> Confirmar {{ tipo_operacao }}`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    errorMessageContainer.innerHTML = `<div class="alert alert-danger">Ocorreu um erro de comunicação. Tente novamente.</div>`;
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<i class="bi bi-check2-circle"></i> Confirmar {{ tipo_operacao }}`;
                });
        });
    });
</script>
{% endblock %}
